<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="chrome=1">
    <title>metrics-spring by ryantenney</title>

    <link rel="stylesheet" href="stylesheets/styles.css">
    <link rel="stylesheet" href="stylesheets/pygment_trac.css">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <!--[if lt IE 9]>
    <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
  </head>
  <body>
    <div class="wrapper">
      <header>
        <h1>metrics-spring</h1>
        <p>Spring integration for Yammer&#39;s Metrics library</p>

        <p class="view"><a href="https://github.com/ryantenney/metrics-spring">View the Project on GitHub <small>ryantenney/metrics-spring</small></a></p>


        <ul>
          <li><a href="https://github.com/ryantenney/metrics-spring/zipball/master">Download <strong>ZIP File</strong></a></li>
          <li><a href="https://github.com/ryantenney/metrics-spring/tarball/master">Download <strong>TAR Ball</strong></a></li>
          <li><a href="https://github.com/ryantenney/metrics-spring">View On <strong>GitHub</strong></a></li>
        </ul>
      </header>
      <section>
        <h1>
<a name="metrics-for-spring-" class="anchor" href="#metrics-for-spring-"><span class="octicon octicon-link"></span></a>Metrics for Spring <a href="http://travis-ci.org/ryantenney/metrics-spring"><img src="https://secure.travis-ci.org/ryantenney/metrics-spring.png" alt="Build Status"></a>
</h1>

<h2>
<a name="about" class="anchor" href="#about"><span class="octicon octicon-link"></span></a>About</h2>

<p>The <code>metrics-spring</code> module integrates <a href="http://metrics.codahale.com/">Yammer Metrics</a> with Spring AOP, and provides XML and Java configuration.</p>

<p>This module does the following things:</p>

<ul>
<li>Proxies beans which contain methods annotated with <code>@Timed</code>, <code>@Metered</code>, <code>@ExceptionMetered</code>, and <code>@Counted</code>
</li>
<li>Registers a <code>Gauge</code> for beans which have members annotated with <code>@Gauge</code>
</li>
<li>Autowires Timers, Meters, Counters and Histograms into fields annotated with <code>@InjectMetric</code>
</li>
<li>Registers with the <code>HealthCheckRegistry</code> any beans which extend the class <code>HealthCheck</code>
</li>
<li>Creates reporters and binds them to the Spring lifecycle</li>
</ul><h3>
<a name="maven" class="anchor" href="#maven"><span class="octicon octicon-link"></span></a>Maven</h3>

<p>Current version is 3.0.0-RC2, which is compatible with Metrics 3.0</p>

<div class="highlight highlight-xml"><pre><span class="nt">&lt;dependency&gt;</span>
    <span class="nt">&lt;groupId&gt;</span>com.ryantenney.metrics<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>metrics-spring<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>3.0.0-RC2<span class="nt">&lt;/version&gt;</span>
<span class="nt">&lt;/dependency&gt;</span>
</pre></div>

<p>This module was formerly contained in the <a href="https://github.com/codahale/metrics">Yammer Metrics repository</a>.</p>

<h3>
<a name="basic-usage" class="anchor" href="#basic-usage"><span class="octicon octicon-link"></span></a>Basic Usage</h3>

<p>As of version 3, <code>metrics-spring</code> may be configured using XML or Java, depending on your personal preference.</p>

<p>Spring Context XML:</p>

<div class="highlight highlight-xml"><pre><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
       <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
       <span class="na">xmlns:metrics=</span><span class="s">"http://www.ryantenney.com/schema/metrics"</span>
       <span class="na">xsi:schemaLocation=</span><span class="s">"</span>
<span class="s">            http://www.springframework.org/schema/beans</span>
<span class="s">            http://www.springframework.org/schema/beans/spring-beans-3.2.xsd</span>
<span class="s">            http://www.ryantenney.com/schema/metrics</span>
<span class="s">            http://www.ryantenney.com/schema/metrics/metrics-3.0.xsd"</span><span class="nt">&gt;</span>

    <span class="c">&lt;!-- registry and reporters should be defined in only one context xml file --&gt;</span>
    <span class="nt">&lt;metrics:metric-registry</span> <span class="na">id=</span><span class="s">"registry"</span> <span class="na">name=</span><span class="s">"springMetrics"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;metrics:reporter</span> <span class="na">type=</span><span class="s">"console"</span> <span class="na">metric-registry=</span><span class="s">"registry"</span> <span class="na">period=</span><span class="s">"1m"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- annotation-driven must be included in all context files --&gt;</span>
    <span class="nt">&lt;metrics:annotation-driven</span> <span class="na">metric-registry=</span><span class="s">"registry"</span> <span class="nt">/&gt;</span>

    <span class="c">&lt;!-- beans --&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</pre></div>

<p>Java Annotation Config:</p>

<div class="highlight highlight-java"><pre><span class="kn">import</span> <span class="nn">java.util.concurrent.TimeUnit</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.annotation.Configuration</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.codahale.metrics.ConsoleReporter</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.codahale.metrics.MetricRegistry</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.codahale.metrics.SharedMetricRegistries</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ryantenney.metrics.spring.config.annotation.EnableMetrics</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">com.ryantenney.metrics.spring.config.annotation.MetricsConfigurerAdapter</span><span class="o">;</span>

<span class="nd">@Configuration</span>
<span class="nd">@EnableMetrics</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringConfiguringClass</span> <span class="kd">extends</span> <span class="n">MetricsConfigurerAdapter</span> <span class="o">{</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">MetricRegistry</span> <span class="nf">getMetricRegistry</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="n">SharedMetricRegistries</span><span class="o">.</span><span class="na">getOrCreate</span><span class="o">(</span><span class="s">"springMetrics"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">configureReporters</span><span class="o">(</span><span class="n">MetricRegistry</span> <span class="n">metricRegistry</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ConsoleReporter</span><span class="o">.</span><span class="na">forRegistry</span><span class="o">(</span><span class="n">registry</span><span class="o">)</span>
            <span class="o">.</span><span class="na">outputTo</span><span class="o">(</span><span class="n">output</span><span class="o">)</span>
            <span class="o">.</span><span class="na">build</span><span class="o">()</span>
            <span class="o">.</span><span class="na">start</span><span class="o">(</span><span class="mi">1</span><span class="o">,</span> <span class="n">TimeUnit</span><span class="o">.</span><span class="na">MINUTES</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</pre></div>

<h3>
<a name="xml-config-documentation" class="anchor" href="#xml-config-documentation"><span class="octicon octicon-link"></span></a>XML Config Documentation</h3>

<p>The <code>&lt;metrics:annotation-driven /&gt;</code> element is required, and has 4 optional arguments:</p>

<ul>
<li>
<code>metric-registry</code> - the id of the <code>MetricRegsitry</code> bean with which the generated metrics should be registered. If omitted a new <code>MetricRegistry</code> bean is created.</li>
<li>
<code>health-check-registry</code> - the id of the <code>HealthCheckRegsitry</code> bean with which to register any beans which extend the class <code>HealthCheck</code>. If omitted a new <code>HealthCheckRegistry</code> bean is created.</li>
<li>
<code>proxy-target-class</code> - if set to true, always creates CGLIB proxies instead of defaulting to JDK proxies. This <em>may</em> be necessary if you use class-based autowiring.</li>
<li>
<code>expose-proxy</code> - if set to true, the target can access the proxy which wraps it by calling <code>AopContext.currentProxy()</code>.</li>
</ul><p>The <code>&lt;metrics:metric-registry /&gt;</code> element constructs a new MetricRegistry or retrieves a shared registry:</p>

<ul>
<li>
<code>id</code> - the bean name with which to register the MetricRegistry bean</li>
<li>
<code>name</code> - the name of the MetricRegistry, if present, this calls SharedMetricRegistries.getOrCreate(name)</li>
</ul><p>The <code>&lt;metrics:health-check-registry /&gt;</code> element constructs a new HealthCheckRegistry:</p>

<ul>
<li>
<code>id</code> - the bean name with which to register the HealthCheckRegistry bean</li>
</ul><p>The <code>&lt;metrics:reporter /&gt;</code> element creates and starts a reporter.</p>

<ul>
<li>
<code>id</code> - the bean name</li>
<li>
<code>metric-registry</code> - the id of the <code>MetricRegsitry</code> bean for which the reporter should retrieve metrics</li>
<li>
<code>type</code> - the type of the reporter. Additional types may be registered through SPI (more on this later).

<ul>
<li>
<code>console</code>: ConsoleReporter</li>
<li>
<code>jmx</code>: JmxReporter</li>
<li>
<code>slf4j</code>: Slf4jReporter</li>
<li>
<code>ganglia</code>: GangliaReporter (requires <code>metrics-ganglia</code>)</li>
<li>
<code>graphite</code>: GraphiteReporter (requires <code>metrics-graphite</code>)</li>
</ul>
</li>
</ul><h3>
<a name="java-config-documentation" class="anchor" href="#java-config-documentation"><span class="octicon octicon-link"></span></a>Java Config Documentation</h3>

<p>A <code>@Configuration</code> class annotated with <code>@EnableMetrics</code> is functionally equivalent to using the <code>&lt;metrics:annotation-driven /&gt;</code> element.</p>

<ul>
<li>
<code>proxyTargetClass</code> - if set to true, always creates CGLIB proxies instead of defaulting to JDK proxies. This <em>may</em> be necessary if you use class-based autowiring.</li>
<li>
<code>exposeProxy</code> - if set to true, the target can access the proxy which wraps it by calling <code>AopContext.currentProxy()</code>.</li>
</ul><p>The class may also implement the interface <code>MetricsConfigurer</code>, or extend the abstract class <code>MetricsConfigurerAdapter</code></p>

<ul>
<li>
<code>getMetricRegistry()</code> - return the <code>MetricRegsitry</code> instance with which metrics should be registered. If omitted a new <code>MetricRegistry</code> instance is created.</li>
<li>
<code>getHealthCheckRegistry()</code> - return the <code>HealthCheckRegsitry</code> instance with which to register any beans which extend the class <code>HealthCheck</code>. If omitted a new <code>HealthCheckRegistry</code> instance is created.</li>
<li>
<code>configureReporters(MetricRegistry)</code> - configure reporters</li>
</ul><h3>
<a name="a-note-on-the-limitations-of-spring-aop" class="anchor" href="#a-note-on-the-limitations-of-spring-aop"><span class="octicon octicon-link"></span></a>A Note on the Limitations of Spring AOP</h3>

<p>Due to limitations of Spring AOP only public methods can be proxied, so <code>@Timed</code>, <code>@Metered</code>, <code>@ExceptionMetered</code>, and <code>@Counted</code> have no effect on non-public methods. Additionally, calling an annotated method from within the same class will not go through the proxy.</p>

<div class="highlight highlight-java"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">Foo</span> <span class="o">{</span>

    <span class="nd">@Timed</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">bar</span><span class="o">()</span> <span class="o">{</span> <span class="cm">/* … */</span> <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">baz</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">bar</span><span class="o">();</span> <span class="c1">// doesn't pass through the proxy</span>

        <span class="c1">// fix: reengineer</span>
        <span class="c1">// workaround: enable `expose-proxy` and change to:</span>
        <span class="o">((</span><span class="n">Foo</span><span class="o">)</span> <span class="n">AopContext</span><span class="o">.</span><span class="na">currentProxy</span><span class="o">()).</span><span class="na">bar</span><span class="o">();</span> <span class="c1">// hideous, but it works</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>

<p>As <code>@Gauge</code> doesn’t involve a proxy, it may be used on non-public fields and methods.
Additionally, <code>@InjectMetric</code> may be used on non-public, non-final fields.</p>

<h3>
<a name="users-of-the-maven-shade-plugin" class="anchor" href="#users-of-the-maven-shade-plugin"><span class="octicon octicon-link"></span></a>Users of the Maven Shade plugin</h3>

<p>Please see the <a href="SHADE-README.md">Shade Readme</a></p>

<hr><h3>
<a name="license" class="anchor" href="#license"><span class="octicon octicon-link"></span></a>License</h3>

<p>Copyright (c) 2012-2013 Ryan Tenney, Martello Technologies</p>

<p>Published under Apache Software License 2.0, see LICENSE</p>

<p><a href="http://rochestermade.com"><img src="http://rochestermade.com/media/images/rochester-made-dark-on-light.png" alt="Rochester Made"></a></p>
      </section>
      <footer>
        <p>This project is maintained by <a href="https://github.com/ryantenney">ryantenney</a></p>
        <p><small>Hosted on GitHub Pages &mdash; Theme by <a href="https://github.com/orderedlist">orderedlist</a></small></p>
      </footer>
    </div>
    <script src="javascripts/scale.fix.js"></script>
              <script type="text/javascript">
            var gaJsHost = (("https:" == document.location.protocol) ? "https://ssl." : "http://www.");
            document.write(unescape("%3Cscript src='" + gaJsHost + "google-analytics.com/ga.js' type='text/javascript'%3E%3C/script%3E"));
          </script>
          <script type="text/javascript">
            try {
              var pageTracker = _gat._getTracker("UA-3831117-9");
            pageTracker._trackPageview();
            } catch(err) {}
          </script>

  </body>
</html>